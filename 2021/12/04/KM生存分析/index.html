<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="这是关于KM生存分析的notebook，记录了关于KM的基本方法。">
<meta property="og:type" content="article">
<meta property="og:title" content="KM生存分析">
<meta property="og:url" content="https://biobrick.github.io/2021/12/04/KM%E7%94%9F%E5%AD%98%E5%88%86%E6%9E%90/">
<meta property="og:site_name" content="Bio Harbor">
<meta property="og:description" content="这是关于KM生存分析的notebook，记录了关于KM的基本方法。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-12-03T19:58:51.000Z">
<meta property="article:modified_time" content="2021-12-03T20:00:48.000Z">
<meta property="article:author" content="Chong Yin">
<meta name="twitter:card" content="summary"><title>KM生存分析 | Bio Harbor</title><link ref="canonical" href="https://biobrick.github.io/2021/12/04/KM%E7%94%9F%E5%AD%98%E5%88%86%E6%9E%90/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: true,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 6.0.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Bio Harbor</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">KM生存分析</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-12-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-12-04</span></span></div></header><div class="post-body">
        <h2 id="1-notebook总述">
          <a href="#1-notebook总述" class="heading-link"><i class="fas fa-link"></i></a><a href="#1-notebook总述" class="headerlink" title="1.notebook总述"></a>1.notebook总述</h2>
      <p>这是关于KM生存分析的notebook，记录了关于KM的基本方法，使用案例，基本结果，误差调整方案，统计检验方法等基本内容。希望彻底把这一块搞清楚。</p>
<p>还包括了一些基本的绘图，生存曲线，统计量，特别是样本分组表这种描述性的结果。</p>

        <h2 id="2-加载分析所需包">
          <a href="#2-加载分析所需包" class="heading-link"><i class="fas fa-link"></i></a><a href="#2-加载分析所需包" class="headerlink" title="2.加载分析所需包"></a>2.加载分析所需包</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">library(tidyverse)</span><br><span class="line">library(survival)</span><br><span class="line">library(survivalROC)</span><br><span class="line">library(survminer)</span><br><span class="line">library(tidyfst)</span><br></pre></td></tr></table></div></figure>

        <h2 id="3-加载分析数据，数据来源是TCGA-COAD">
          <a href="#3-加载分析数据，数据来源是TCGA-COAD" class="heading-link"><i class="fas fa-link"></i></a><a href="#3-加载分析数据，数据来源是TCGA-COAD" class="headerlink" title="3.加载分析数据，数据来源是TCGA-COAD"></a>3.加载分析数据，数据来源是TCGA-COAD</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">expset &lt;- read.table(file = &quot;./data/TCGA-COAD-fpkm.tsv&quot;,check.names = F,sep = &quot;\t&quot;,header = T)</span><br><span class="line">meta &lt;- read.csv(file = &quot;./data/TCGA-COAD-meta.csv&quot;,check.names = F,header = T)</span><br><span class="line">surv &lt;- read.table(file = &quot;./data/TCGA-COAD.survival.tsv&quot;,check.names = F,sep = &quot;\t&quot;,header = T)</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">row.names(expset) &lt;- expset$Ensembl_ID</span><br><span class="line">expset &lt;- expset[,-1]</span><br><span class="line">names(meta)[1] &lt;- &quot;sample&quot;</span><br></pre></td></tr></table></div></figure>

        <h2 id="4-描述性统计分析">
          <a href="#4-描述性统计分析" class="heading-link"><i class="fas fa-link"></i></a><a href="#4-描述性统计分析" class="headerlink" title="4.描述性统计分析"></a>4.描述性统计分析</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#查看数据形状</span><br><span class="line">dim(expset)</span><br><span class="line">dim(meta)</span><br><span class="line">dim(surv)</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">boxplot(expset[,1:5])</span><br><span class="line">#查看缺失情况</span><br><span class="line">Amelia::missmap(meta)</span><br><span class="line">Amelia::missmap(surv)</span><br></pre></td></tr></table></div></figure>
<p>表达矩阵有6W+个基因，512个病人，meta中有120项meta，571个病人，而生存数据则有539个病人，4个特征，需要取最小交集后续分析。</p>
<p>此外，表达矩阵是带版本号的ensembl基因ID，理论上也可以最后再进行注释，但真正分析中肯定会在一开始进行注释，为了后续其他的分析，在此使用genecode.v22.probemap文件进行注释。</p>
<p>数据完整性上，表达矩阵和生存数据没有缺失，但meta信息中存在大量的缺失数据，需要进行缺失处理。</p>
<p>因此，数据处理的流程应当是：</p>
<p>1.处理meta中的缺失;</p>
<p>2.获得最小sample的交集作为全部的样本集;</p>
<p>3.表达矩阵的注释;</p>
<p>4.数据检查，固定外键为sample;</p>
<p>5.干净数据的存储持久化;</p>

        <h2 id="5-数据整理">
          <a href="#5-数据整理" class="heading-link"><i class="fas fa-link"></i></a><a href="#5-数据整理" class="headerlink" title="5.数据整理"></a>5.数据整理</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#处理meta中的缺失，阈值选择为5%(571*5%=30)</span><br><span class="line">meta[meta==&quot;&quot;] &lt;- NA</span><br><span class="line"></span><br><span class="line">coad.meta &lt;- meta %&gt;%</span><br><span class="line">  tidyfst::delete_na_cols(n = 30) %&gt;%</span><br><span class="line">  tidyfst::delete_na_rows(n = 1)</span><br><span class="line"></span><br><span class="line">#获取最小sampleid的集合</span><br><span class="line">commonsample = intersect(surv$sample,intersect(colnames(expset),coad.meta$sample))</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#借助probemap进行基因注释，同时使用同版本的gtf文件注释编码基因</span><br><span class="line">probemap &lt;- read.table(file = &quot;./data/gencodev22probeMap&quot;,sep = &quot;\t&quot;,header = T,check.names = F)</span><br><span class="line"></span><br><span class="line">expset$id &lt;- row.names(expset)</span><br><span class="line"></span><br><span class="line">coad.exp &lt;- probemap %&gt;%</span><br><span class="line">  select(.,id,gene) %&gt;%</span><br><span class="line">  left_join(.,expset,by = &quot;id&quot;) %&gt;%</span><br><span class="line">  subset(.,select = -id)</span><br><span class="line"></span><br><span class="line">gtfv22 &lt;- rtracklayer::import(&quot;./data/gencode.v22.annotation.gtf&quot;) %&gt;%</span><br><span class="line">  as.data.frame(.) %&gt;%</span><br><span class="line">  select(.,c(&quot;gene_id&quot;,&quot;gene_type&quot;, &quot;gene_name&quot;)) %&gt;% </span><br><span class="line">  subset(., gene_type == &quot;protein_coding&quot;) %&gt;% </span><br><span class="line">  distinct(.,gene_name,.keep_all = T)</span><br><span class="line"></span><br><span class="line">coad.exp &lt;- coad.exp %&gt;% </span><br><span class="line">  filter(.,gene %in% all_of(gtfv22$gene_name)) %&gt;%</span><br><span class="line">  distinct(.,gene,.keep_all = T)</span><br><span class="line">row.names(coad.exp) &lt;- coad.exp$gene</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#固定外键为sample，完成三者meta的全匹配</span><br><span class="line">coad.exp &lt;- coad.exp %&gt;% select(.,all_of(commonsample))</span><br><span class="line">coad.meta &lt;- coad.meta %&gt;% filter(.,sample %in% all_of(commonsample))</span><br><span class="line">coad.surv &lt;- surv %&gt;% filter(.,sample %in% all_of(commonsample))</span><br><span class="line">coad.surv &lt;- coad.surv[,-3]</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#干净数据的持久化</span><br><span class="line">write.csv(coad.exp,file = &quot;./data/coad.exp.csv&quot;)</span><br><span class="line">write.csv(coad.meta,file = &quot;./data/coad.meta.csv&quot;)</span><br><span class="line">write.csv(coad.surv,file = &quot;./data/coad.surv.csv&quot;)</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#清理变量，释放内存</span><br><span class="line">rm(expset,meta,surv,gtfv22,probemap)</span><br><span class="line">gc()</span><br></pre></td></tr></table></div></figure>

        <h2 id="6-最简单的KM生存，随便选个基因">
          <a href="#6-最简单的KM生存，随便选个基因" class="heading-link"><i class="fas fa-link"></i></a><a href="#6-最简单的KM生存，随便选个基因" class="headerlink" title="6.最简单的KM生存，随便选个基因"></a>6.最简单的KM生存，随便选个基因</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">coad.exp.tmp &lt;- as.data.frame(t(coad.exp))</span><br><span class="line">coad.surv.tmp &lt;- coad.surv %&gt;% mutate(.,CXCL5 = coad.exp.tmp$CXCL5)</span><br><span class="line"></span><br><span class="line">survgrouptmp &lt;- ifelse(coad.surv.tmp$CXCL5&gt;median(coad.surv.tmp$CXCL5),&#x27;CXCL5High&#x27;,&#x27;CXCL5low&#x27;)</span><br><span class="line"></span><br><span class="line">survivaltmp &lt;-survfit(Surv(coad.surv.tmp$OS.time, coad.surv.tmp$OS)~survgrouptmp, data=coad.surv.tmp,)</span><br><span class="line"></span><br><span class="line">ggsurvplot(survivaltmp,</span><br><span class="line">           conf.int=T,</span><br><span class="line">           pval=T,</span><br><span class="line">           pval.method = T,</span><br><span class="line">           risk.table = F,</span><br><span class="line">           ggtheme = theme_bw(),</span><br><span class="line">           surv.median.line = &quot;hv&quot;,)</span><br><span class="line"></span><br><span class="line">ggsave(filename = &quot;survtmp.pdf&quot;,height = 8,width = 8)</span><br></pre></td></tr></table></div></figure>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rm(coad.exp.tmp,coad.surv.tmp)</span><br><span class="line">rm(survgrouptmp)</span><br><span class="line">gc()</span><br></pre></td></tr></table></div></figure>

        <h2 id="7-循环筛选KM显著的单基因-暂只考虑log-rank校验">
          <a href="#7-循环筛选KM显著的单基因-暂只考虑log-rank校验" class="heading-link"><i class="fas fa-link"></i></a><a href="#7-循环筛选KM显著的单基因-暂只考虑log-rank校验" class="headerlink" title="7.循环筛选KM显著的单基因,暂只考虑log-rank校验"></a>7.循环筛选KM显著的单基因,暂只考虑log-rank校验</h2>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#组合成完整的数据表</span><br><span class="line">coad.exp &lt;- as.data.frame(t(coad.exp))</span><br><span class="line"></span><br><span class="line">#以FPKM&gt;1作为表达阈值，需要在至少70%样本内有表达视为有效基因</span><br><span class="line">coad.exp.use&lt;- coad.exp[colSums(coad.exp&gt;=1)&gt;=314]</span><br><span class="line"></span><br><span class="line">#如果还需要对样本至少表达10000基因进行筛选，形式类似</span><br><span class="line">#coad.exp.tmp &lt;- coad.exp[rowSums(coad.exp&gt;=1)&gt;=10000]</span><br><span class="line">surv.allgene &lt;- cbind(coad.exp.use,coad.surv)</span><br><span class="line">surv.allgene[1:5,1:5]</span><br><span class="line">#方法1:手写循环</span><br><span class="line"></span><br><span class="line">mySurv=with(surv.allgene,Surv(OS.time, OS))</span><br><span class="line"></span><br><span class="line">log_rank_p &lt;- apply(surv.allgene, 2 , function(gene)&#123;</span><br><span class="line">  surv.allgene$group=ifelse(gene&gt;median(gene),&#x27;high&#x27;,&#x27;low&#x27;)  </span><br><span class="line">  data.survdiff=survdiff(mySurv~group,data=surv.allgene)</span><br><span class="line">  p.val = 1 - pchisq(data.survdiff$chisq, length(data.survdiff$n) - 1)</span><br><span class="line">  return(p.val)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">log_rank_p=sort(log_rank_p)</span><br><span class="line">log_rank_p_sig &lt;- as.data.frame(log_rank_p[log_rank_p &lt; 0.05])</span><br><span class="line">kmsiggene &lt;- row.names(log_rank_p_sig)</span><br><span class="line">kmsiggene &lt;- kmsiggene[c(-1,-2)]</span><br></pre></td></tr></table></div></figure>
<p>可以看到，最后我们获得了740个log_rank_p显著的基因，可以使用这种方法从大量的基因中缩小基因群体，整个运算速度也很快，后续可以接批量的绘图就能得到全部显著的单基因km了。当然，也可以根据功能、DEG、相关性等进行进一步的基因筛选，最后得到最佳的功能基因集。此外，此处只考虑了编码基因，如果要进行调控网络分析，还可以纳入非编码的基因。</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#方法2，tinyarray::surv_km，既然有手写，那肯定有大佬已经帮忙写好了，这里就推荐一个最佳选择，tinyarray中批量生存的功能。surv_km只需要有表达矩阵和匹配的meta即可，返回log-rank-p值</span><br><span class="line">require(tinyarray)</span><br><span class="line">#tinyarray数据格式需要将生存的名字改为event和time</span><br><span class="line">coad.exp.use &lt;- as.data.frame(t(coad.exp.use))</span><br><span class="line">names(coad.surv) &lt;- c(&quot;sample&quot;,&quot;event&quot;,&quot;time&quot;)</span><br><span class="line"></span><br><span class="line">log_rank_p &lt;- surv_KM(coad.exp.use,coad.surv,cut.point = FALSE)</span><br><span class="line">log_rank_p_sig &lt;- as.data.frame(log_rank_p[log_rank_p &lt; 0.05])</span><br><span class="line">kmsiggene &lt;- row.names(log_rank_p_sig)</span><br></pre></td></tr></table></div></figure>
<p>结果一致，也是740个基因，基因也一致，表明这两种方法的确是等价的，但是看surv_km的源码，它用的是for循环，但是手写部分用的apply，就R来说应该选择前者，虽然用tinyarray的方法看上去更简洁。</p>

        <h2 id="8-KM的变体问题">
          <a href="#8-KM的变体问题" class="heading-link"><i class="fas fa-link"></i></a><a href="#8-KM的变体问题" class="headerlink" title="8.KM的变体问题"></a>8.KM的变体问题</h2>
      <p>变体问题1，统计检验方法问题，log-rank-p的适用性和检验power</p>
<p>log-rank-p的检验对等比例风险假定没有特别要求，但是根据搜索，有文章提到如果不满足PH假设，检验效能会受到影响而削弱，而在满足PH假定的前提下，log-rank检验的效能是最强的。此外，如果生存曲线有交叉，则存在混杂因素，理论上应该选择cox多因素分析之后去除混杂因素。log rank检验对于远期变化敏感，各时间点的存活死亡权重一样，具体到结果里就是，看上去近期曲线分得不是很开，但log-rank-p仍然显著。</p>
<p>然而这并不是说为了让p值显著，就应该“近处显著选近，远处显著选远，都不显著选中”，一切基于具体问题，比如研究短期疗效，就应该选择Breslow-Wilcoxon检验近期效能，要研究长期效应，就应该选择log-rank</p>
<p>变体问题2，log-rank、Breslow-Wilcoxon与Tarone-Ware</p>
<p>在survdiff中，有一个参数是rho，根据文档：<br>“With rho = 0 this is the log-rank or Mantel-Haenszel test, and with rho = 1 it is equivalent to the Peto &amp; Peto modification of the Gehan-Wilcoxon test.”</p>
<p>就是rho=0就是默认的log-rank检验，rho=1则是广义Wilcoxon（Gehan-Wilcoxon和Breslow-Wilcoxon就是一个东西），一个远期一个近期，具体到代码里，只需要在survdiff的那一行加上rho=0/1即可。</p>
<p>变体问题3，KM调整，最佳cutoff与模型调整</p>
<p>很多时候，以median、mean或者其他常见统计量作为截断点得到的生存并不显著，这既和检验方法有关，也和具体数据的分布有关，检验方法的问题上面已经说了，长期远期要选对；其二就是数据分布的问题，mean、median等统计量其实只代表数据的总体特征，但不代表这种特征和其他变量存在关联，因此并不一定合适，这时就可以借用survminer的surv_cutpoint函数，就可以返回所谓的最佳截断点，这个数值代表了所选指标在统计学上的最优位置，简单来说就是截断点数值的benchmark然后返回p值或者某种评价指标最佳的数值，如果最佳截断点分群也无法让分组差异变得明显，那就说明在当前数据下，该数值模型本身就是不显著，要么增删新的变量，要么调整建模方法，要么接受结果。例如：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#选几个不怎么显著的基因</span><br><span class="line">surv.tmp &lt;- subset(surv.allgene,select = c(&quot;OS.time&quot;,&quot;OS&quot;,&quot;HSPA1A&quot;,&quot;XPC&quot;))</span><br><span class="line"></span><br><span class="line">#使用median,不怎么显著</span><br><span class="line">surv.tmp$group &lt;- ifelse(surv.tmp$XPC&gt;median(surv.tmp$XPC),&#x27;high&#x27;,&#x27;low&#x27;)</span><br><span class="line">survdiff(Surv(OS.time,OS)~group,data=surv.tmp)</span><br><span class="line"></span><br><span class="line">#使用mean，更不显著了</span><br><span class="line">surv.tmp$group &lt;- ifelse(surv.tmp$XPC&gt;mean(surv.tmp$XPC),&#x27;high&#x27;,&#x27;low&#x27;)</span><br><span class="line">survdiff(Surv(OS.time,OS)~group,data=surv.tmp)</span><br><span class="line"></span><br><span class="line">#使用最佳截断,虽然还是不显著，但比最初好太多了.....(其实意思就是没得救了)</span><br><span class="line">res.cut &lt;- surv_cutpoint(surv.tmp, time = &quot;OS.time&quot;, event = &quot;OS&quot;,variables = &quot;XPC&quot;)</span><br><span class="line">surv.tmp$group &lt;- ifelse(surv.tmp$XPC&gt;mean(res.cut$cutpoint$cutpoint),&#x27;high&#x27;,&#x27;low&#x27;)</span><br><span class="line"></span><br><span class="line">survdiff(Surv(OS.time,OS)~group,data=surv.tmp)</span><br><span class="line"></span><br><span class="line">#看一下数据分布</span><br><span class="line">plot(res.cut, &quot;XPC&quot;, palette = &quot;npg&quot;)</span><br></pre></td></tr></table></div></figure>
<p>大致能看到cutoff的原理，以及选择的cutoff处于数据中的位置，这里的cutoff明显是偏得比较多了，这种情况下即便能够让模型变得显著也最好别用。</p>
<p>因此能够得到对KM优化的基本原则：<br>1.确定研究目标，研究长期效应使用log-rank，研究短期选择wilcoxon；<br>2.确定等比例风险情况，KM的检验可以容忍一定程度的偏移，但不能过分偏离PH假设；<br>3.批量筛选，缩小可选的范围，再另行取交集或者使用多因素模型进一步分析；<br>4.确定最佳截断，通常使用中位数，可以考虑使用最佳截断，但要注意截断点的数据位置；<br>5.不定向调整，此部分内容很多，没有定式，但通常包括了重新进行特征工程（比如数据变换），调整纳入的变量（比如OS不好时新增DFS），从整体模型降为局部模型（比如截断型生存，只研究3年内的生存情况），以及更加精细的模型构建（比如下面的分层和分时模型）。<br>6.接受现实，KM是一个思路上相对简单的模型，简单模型本身能做到的事情就有限。这是一个完全成熟的模型，指望它做出“别人”没发现过的显著结果本身就是不可能的。因此，想要模型优秀，请回去检查实验设计和数据本身。</p>

        <h1 id="9-KM曲线可视化">
          <a href="#9-KM曲线可视化" class="heading-link"><i class="fas fa-link"></i></a><a href="#9-KM曲线可视化" class="headerlink" title="9.KM曲线可视化"></a>9.KM曲线可视化</h1>
      <figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">surv.tmp$group &lt;- ifelse(surv.tmp$HSPA1A&gt;median(surv.tmp$HSPA1A),&#x27;high&#x27;,&#x27;low&#x27;)</span><br><span class="line">surv.fit &lt;- survfit(Surv(OS.time,OS)~group,data=surv.tmp)</span><br><span class="line"></span><br><span class="line">#简单曲线,一行即可</span><br><span class="line">#plot(surv.fit)开玩笑的，这种线算个屁的可视化</span><br><span class="line">ggsurvplot(surv.fit,pval.method = T,pval = T)</span><br><span class="line"></span><br><span class="line">#标准曲线,根据医学文献，标准的km曲线应当包含统计量，统计方法和风险表。</span><br><span class="line">ggsurvplot(surv.fit,</span><br><span class="line">           pval.method = T,#是否添加统计检验的方法</span><br><span class="line">           pval = T,#是否添加p值</span><br><span class="line">           conf.int = T,#是否展示置信区间</span><br><span class="line">           risk.table = T,#是否展示风险进度表格</span><br><span class="line">           surv.median.line = &quot;hv&quot;,#是否绘制50%生存线</span><br><span class="line">           tables.theme = theme_classic2(),#风险进度表的主题</span><br><span class="line">           ggtheme = theme_classic2(),#生存曲线图的主题</span><br><span class="line">           )</span><br><span class="line"></span><br><span class="line">#进阶修改</span><br><span class="line">ggsurvplot(surv.fit,</span><br><span class="line">           palette = &quot;uchicago&quot;,#改配色，个人觉得这个配色最好</span><br><span class="line">           pval.method = T,#添加统计检验的方法</span><br><span class="line">           pval = T,#添加p值</span><br><span class="line">           conf.int = T,#展示置信区间</span><br><span class="line">           conf.int.style = &quot;step&quot;,#置信区间风格,可选ribbon和step</span><br><span class="line">           #conf.int.fill设置置信区间填充的颜色</span><br><span class="line">           #conf.int.alpha指定置信区间填充颜色的透明度；</span><br><span class="line">           risk.table = T,#展示风险进度表格</span><br><span class="line">           surv.median.line = &quot;hv&quot;,#是否绘制50%生存线</span><br><span class="line">           tables.theme = theme_classic2(),#风险进度表的主题</span><br><span class="line">           ggtheme = theme_classic2(),#生存曲线图的主题</span><br><span class="line">           add.all = TRUE,#是否添加全部患者的生存情况，一般这条线应该在中间</span><br><span class="line">           legend=&quot;right&quot;, #指定图例的位置</span><br><span class="line">           legend.title = &quot;Group By Gene&quot;, #指定图例组的名字</span><br><span class="line">           legend.labs = c(&quot;All&quot;,&quot;HighGroup&quot;,&quot;LowGroup&quot;), #指定图例标签的字符向量</span><br><span class="line">           axes.offset = FALSE#指定坐标轴从0开始</span><br><span class="line">           #fun = &quot;cumhaz&quot; 使用该fun则会绘制累计风险曲线</span><br><span class="line">           )</span><br></pre></td></tr></table></div></figure>
<p>ggsurvplot的内置参数可谓相当地多，基本所有图上面的东西，从字体到位置全部能直接调整，唯一的问题是，ggsurvplot返回的不是ggplot2对象，反而不能适配一些ggplot2调整的额外包，如果想要像ggplot2一样用的话，使用print(p)即可进行组合或者pdf保存。</p>
<p>可视化的部分，最后的进阶可视化其实没啥必要，也不是最重要的部分，重要的是前面统计的内容。</p>
<p>基本上KM的内容就到此为止，更加进阶的KM，比如分层分时其实没什么必要，那种数据用COX或者其他机器学习的模型，加上多因素的筛选之类的综合方法来做更合适，不要强求KM。</p>
<p>另外，说一个最重要的点，KM曲线除了p值之外，另外一个重要的东西就是曲线是否交叉，理论上KM曲线应该是不会交叉的，如果交叉说明当前的分组存在问题，多变量之间有混杂效应，而如果只有一个自变量分组依然存在交叉，说明PH假设有问题，这种情况可以考虑进行数据截断。</p>
<p>最后再次提醒，KM是一个相对简单的计算方法，不要指望能够完成什么惊世骇俗的结果，真正的结果也就一张图和一个统计结果而已。</p>
<p>最后的最后，推荐一下《总之就是非常可爱》动漫～</p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://biobrick.github.io">Chong Yin</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://biobrick.github.io/2021/12/04/KM%E7%94%9F%E5%AD%98%E5%88%86%E6%9E%90/">https://biobrick.github.io/2021/12/04/KM%E7%94%9F%E5%AD%98%E5%88%86%E6%9E%90/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-reward reward"><div class="reward-button">请我喝杯咖啡~</div><div class="reward-qrcode"><span class="reward-qrcode-alipay"><img class="reward-qrcode-alipay__img" src="/images/alipay.png"><div class="reward-qrcode-alipay__text">支付宝打赏</div></span><span class="reward-qrcode-wechat"><img class="reward-qrcode-wechat__img" src="/images/wechatpay.png"><div class="reward-qrcode-wechat__text">微信打赏</div></span></div></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2021/12/07/%E4%B8%8D%E5%AE%8C%E7%BE%8E%E7%9A%84%E7%B4%A7%E6%80%A5%E9%9C%80%E6%B1%82%EF%BC%88%E4%B8%8A%E7%AF%87%EF%BC%89/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">不完美的紧急需求（上篇）</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2021/12/04/%E5%8D%95%E7%BB%86%E8%83%9Ekallisto%E4%BC%A0%E7%BB%9F%E6%B5%81%E7%A8%8B/"><span class="paginator-prev__text">单细胞kallisto传统流程</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-notebook%E6%80%BB%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">
          1.notebook总述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%8A%A0%E8%BD%BD%E5%88%86%E6%9E%90%E6%89%80%E9%9C%80%E5%8C%85"><span class="toc-number">2.</span> <span class="toc-text">
          2.加载分析所需包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%8A%A0%E8%BD%BD%E5%88%86%E6%9E%90%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%95%B0%E6%8D%AE%E6%9D%A5%E6%BA%90%E6%98%AFTCGA-COAD"><span class="toc-number">3.</span> <span class="toc-text">
          3.加载分析数据，数据来源是TCGA-COAD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%8F%8F%E8%BF%B0%E6%80%A7%E7%BB%9F%E8%AE%A1%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">
          4.描述性统计分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%95%B0%E6%8D%AE%E6%95%B4%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">
          5.数据整理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84KM%E7%94%9F%E5%AD%98%EF%BC%8C%E9%9A%8F%E4%BE%BF%E9%80%89%E4%B8%AA%E5%9F%BA%E5%9B%A0"><span class="toc-number">6.</span> <span class="toc-text">
          6.最简单的KM生存，随便选个基因</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E5%BE%AA%E7%8E%AF%E7%AD%9B%E9%80%89KM%E6%98%BE%E8%91%97%E7%9A%84%E5%8D%95%E5%9F%BA%E5%9B%A0-%E6%9A%82%E5%8F%AA%E8%80%83%E8%99%91log-rank%E6%A0%A1%E9%AA%8C"><span class="toc-number">7.</span> <span class="toc-text">
          7.循环筛选KM显著的单基因,暂只考虑log-rank校验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-KM%E7%9A%84%E5%8F%98%E4%BD%93%E9%97%AE%E9%A2%98"><span class="toc-number">8.</span> <span class="toc-text">
          8.KM的变体问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-KM%E6%9B%B2%E7%BA%BF%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-number"></span> <span class="toc-text">
          9.KM曲线可视化</span></a></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/BIOBRICK/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="386396663" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">18</div><div class="sidebar-ov-state-item__name">归档</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Chong Yin</span></div><div><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script></body></html>